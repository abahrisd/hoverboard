<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../bower_components/polymer/lib/utils/import-href.html">

<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="redux-mixin.html">
<link rel="import" href="elements/shared-styles.html">
<link rel="import" href="elements/flex-layout-attr.html">
<link rel="import" href="elements/hoverboard-icons.html">
<link rel="import" href="elements/hero-block/hero-block.html">
<link rel="import" href="elements/footer-block.html">


<dom-module id="hoverboard-app">

  <template>

    <style is="custom-style" include="shared-styles flex flex-alignment positioning"></style>
    <style>

      :host {
        display: block;
        position: relative;
        min-height: 100vh;
      }

      app-drawer app-toolbar {
        padding: 36px 24px 24px;
        border-bottom: 1px solid var(--divider-color);
      }

      app-drawer .dates {
        margin-top: 42px;
        font-size: 22px;
        line-height: 0.95;
      }

      app-drawer .location {
        margin-top: 4px;
        font-size: 15px;
        color: var(--secondary-text-color);
      }

      .drawer-list {
        padding: 16px 0;
        display: block;
      }

      .drawer-list a {
        padding: 8px 24px;
        display: block;
        color: var(--primary-text-color);
      }

      .drawer-list a.selected {
        font-weight: 500;
      }

      app-header {
        --app-header-background-front-layer: {
          background: var(--hero-background-image) 50% 50%;
          transition: background-image 0.5s;
        };
        transition: background-color 0.3s;
        background-color: var(--hero-background-color);
        border-bottom: 1px solid var(--divider-color);
      }

      .header {
        background-color: var(--primary-background-color);
        z-index: 1;
      }

      app-toolbar {
        padding: 0;
        height: auto;
        max-width: 1800px;
      }

      .toolbar-logo {
        --iron-image-height: 32px;
      }

      .nav-item a {
        padding: 0 14px;
        color: var(--primary-text-color);
        text-transform: uppercase;
      }

      .hero-block {
        display: block;
        position: relative;
        min-height: 360px;
      }

      @media (min-width: 640px) {
        app-toolbar {
          padding: 0 36px;
          height: initial;
        }

        .nav-items {
          --paper-tabs-selection-bar-color: var(--default-primary-color);
          --paper-tabs: {
            height: 64px;
          };
        }

        .hero-block {
          min-height: 460px;
        }
      }

    </style>

    <iron-media-query id="mq-phone"
                      full
                      query="(max-width: {$ mediaQueries.xs.max $})"
                      query-matches="{{isPhoneSize}}"></iron-media-query>
    <iron-media-query id="mq-tablet"
                      full
                      query="(min-width: {$ mediaQueries.sm.min $}) and (max-width: {$ mediaQueries.sm.max $})"
                      query-matches="{{isTabletSize}}"></iron-media-query>
    <iron-media-query id="mq-desktop"
                      query="(min-width: {$ mediaQueries.md.min $})"
                      query-matches="{{isDesktopSize}}"></iron-media-query>

    <app-location route="{{appRoute}}"></app-location>
    <app-route
      route="{{appRoute}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>

    <app-drawer-layout drawer-width="300px" force-narrow fullbleed>

      <app-drawer id="drawer" slot="drawer" opened="[[ui.isDrawerOpened]]">
        <app-toolbar layout vertical start>
          <iron-image class="toolbar-logo" src="/images/logo.svg" alt="{$ title $}"></iron-image>
          <h2 class="dates">{$ dates $}</h2>
          <h3 class="location">{$ location.short $}</h3>
        </app-toolbar>

        <iron-selector
          class="drawer-list"
          selected="[[route]]"
          attr-for-selected="path"
          selected-class="selected"
          role="navigation">
          {% for nav in navigation %}
          <a href="{$ nav.permalink $}" path="{$ nav.route $}" on-tap="closeDrawer">{$ nav.title $}</a>
          {% endfor %}
        </iron-selector>
      </app-drawer>

      <app-header-layout>
        <app-header slot="header" effects="waterfall" condenses fixed>
          <app-toolbar class="header" sticky>
            <paper-icon-button
              icon="hoverboard:menu"
              aria-label="Menu"
              hidden$="[[!isPhoneSize]]"
              on-tap="openDrawer">
            </paper-icon-button>
            <div layout horizontal center flex>
              <a href="/" hidden$="[[isPhoneSize]]" layout horizontal>
                <iron-image class="toolbar-logo" src="/images/logo.svg" alt="{$ title $}"></iron-image>
              </a>
            </div>

            <paper-tabs
              class="nav-items"
              selected="[[route]]"
              attr-for-selected="name"
              hidden$="[[isPhoneSize]]"
              role="navigation"
              noink>
              {% for nav in navigation %}
              <paper-tab name="{$ nav.route $}" class="nav-item" link>
                <a href="{$ nav.permalink $}" layout vertical center-center>{$ nav.title $}</a>
              </paper-tab>
              {% endfor %}
            </paper-tabs>
          </app-toolbar>

          <app-toolbar class="hero-block" layout start vertical end-justified>
            <iron-pages selected="[[route]]" attr-for-selected="route">
              {% for nav in navigation %}
              <div route="{$ nav.route $}">
                <h1>{$ nav.title $}</h1>
              </div>
              {% endfor %}
            </iron-pages>
          </app-toolbar>

          <paper-tabs selected="0" sticky>
            <paper-tab>
              Day 1
            </paper-tab>
            <paper-tab>
              Day 2
            </paper-tab>
          </paper-tabs>
        </app-header>

        <div style="height: 200vh"></div>

        <footer-block></footer-block>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>

    class HoverboardApp extends ReduxMixin(Polymer.Element) {

      static get is() {
        return 'hoverboard-app';
      }

      static get properties() {
        return {
          ui: {
            type: Object,
            statePath: 'ui'
          },
          route: {
            type: String,
            statePath: 'route'
          },
          hero: {
            type: Object,
            statePath(state) {
              return state.hero.settings[state.route]
            },
            observer: '_heroChanged'
          }
        };
      }

      static get observers() {
        return [
          '_routeDataChanged(routeData.page)'
        ];
      }

      constructor() {
        super();
        window.performance && performance.mark && performance.mark('hoverboard-app.created');
      }

      ready() {
        super.ready();
        console.log('Hoverboard v2 is ready!');
        this.removeAttribute('unresolved');
        this._ensureLazyLoaded();
      }

      openDrawer() {
        uiActions.toggleDrawer(true);
      }

      closeDrawer() {
        uiActions.toggleDrawer(false);
      }

      _ensureLazyLoaded() {
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
              this.loadComplete = true;
            });
          });
        }
      }

      _heroChanged() {
        this.updateStyles({
          '--hero-background-color': this.hero.background.color || '',
          '--hero-background-image': this.hero.background.image || ''
        });
      }

      _routeDataChanged(page) {
        if (!page && page !== '') {
          return;
        }
        routeActions.setRoute(page);
      }
    }

    customElements.define(HoverboardApp.is, HoverboardApp);

  </script>

</dom-module>
